<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>èµ„æºæ¥å£ç®¡ç†åå°</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.47/vue.global.prod.min.js"></script>
    <style>
        .table-responsive { max-height: 600px; overflow-y: auto; }
        .sticky-thead th { position: sticky; top: 0; background: #212529; z-index: 10; }
    </style>
</head>
<body class="bg-light">

<div id="app" class="container-fluid px-4 mt-4">
    <div class="card shadow border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h4 class="mb-0 text-primary">ğŸ¥ èµ„æºæ¥å£ç®¡ç† <small class="text-muted fs-6">å…± {{ sites.length }} ä¸ªæ¥å£</small></h4>
            <div>
                <input type="file" ref="fileInput" style="display: none" @change="handleFileUpload" accept=".json">
                
                <button class="btn btn-outline-info me-2" @click="$refs.fileInput.click()">å¯¼å…¥ JSON</button>
                <button class="btn btn-outline-primary me-2" @click="exportJSON">å¯¼å‡º JSON</button>
                <button class="btn btn-success me-2" @click="addSite">+ æ–°å¢æ¥å£</button>
                <button class="btn btn-primary" @click="saveSites">ä¿å­˜åˆ°æœ¬åœ°</button>
            </div>
        </div>
        
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-dark sticky-thead">
                        <tr>
                            <th width="60">å¯ç”¨</th>
                            <th width="120">æ ‡è¯†(Key)</th>
                            <th width="180">åç§°</th>
                            <th>API åœ°å€</th>
                            <th width="100" class="text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(site, index) in sites" :key="index">
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" v-model="site.active">
                                </div>
                            </td>
                            <td><input type="text" v-model="site.key" class="form-control form-control-sm font-monospace"></td>
                            <td><input type="text" v-model="site.name" class="form-control form-control-sm"></td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <input type="text" v-model="site.api" class="form-control">
                                    <a :href="site.api" target="_blank" class="btn btn-outline-secondary">æµ‹è¯•</a>
                                </div>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-outline-danger btn-sm" @click="removeSite(index)">åˆ é™¤</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                sites: []
            }
        },
        async mounted() {
            // åˆå§‹åŒ–é€»è¾‘ï¼šæœ¬åœ°ç¼“å­˜ > db.json > ç©º
            const localData = localStorage.getItem('my_sites_config');
            if (localData) {
                this.sites = JSON.parse(localData);
            } else {
                this.loadFromRemote();
            }
        },
        methods: {
            // ä»æœåŠ¡å™¨è½½å…¥ db.json
            async loadFromRemote() {
                try {
                    const res = await fetch('./db.json');
                    if (res.ok) {
                        const data = await res.json();
                        this.sites = Array.isArray(data) ? data : (data.sites || []);
                    }
                } catch (e) {
                    console.error("æ— æ³•ä»æœåŠ¡å™¨è·å–æ•°æ®");
                }
            },
            // æ ¸å¿ƒåŠŸèƒ½ï¼šå¤„ç†æ–‡ä»¶ä¸Šä¼ å¯¼å…¥
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        // å…¼å®¹ä¸¤ç§æ ¼å¼ï¼š[...] æˆ– { "sites": [...] }
                        const importedData = Array.isArray(json) ? json : (json.sites || []);
                        
                        if (importedData.length === 0) {
                            alert('JSON æ ¼å¼ä¸æ­£ç¡®æˆ–æ²¡æœ‰æœ‰æ•ˆæ•°æ®');
                            return;
                        }

                        if (confirm(`æˆåŠŸè¯»å– ${importedData.length} æ¡æ•°æ®ï¼Œæ˜¯å¦è¦†ç›–å½“å‰åˆ—è¡¨ï¼Ÿ`)) {
                            // ç»™æ¯æ¡æ•°æ®è¡¥å…… active å­—æ®µï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
                            this.sites = importedData.map(item => ({
                                active: item.active !== undefined ? item.active : true,
                                key: item.key || 'new',
                                name: item.name || 'æœªå‘½å',
                                api: item.api || ''
                            }));
                            alert('å¯¼å…¥æˆåŠŸï¼è®°å¾—ç‚¹å‡»â€œä¿å­˜åˆ°æœ¬åœ°â€');
                        }
                    } catch (err) {
                        alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿ä¸Šä¼ çš„æ˜¯æ ‡å‡†çš„ .json æ–‡ä»¶');
                    }
                };
                reader.readAsText(file);
                // æ¸…ç©º input æ–¹ä¾¿ä¸‹æ¬¡ä¸Šä¼ åŒåæ–‡ä»¶
                event.target.value = '';
            },
            addSite() {
                this.sites.unshift({ key: 'new', name: 'æ–°èµ„æº', api: '', active: true });
            },
            removeSite(index) {
                if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) this.sites.splice(index, 1);
            },
            saveSites() {
                localStorage.setItem('my_sites_config', JSON.stringify(this.sites));
                alert('å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ï¼');
            },
            exportJSON() {
                const dataStr = JSON.stringify({ "sites": this.sites }, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = "db.json";
                link.click();
            }
        }
    }).mount('#app');
</script>
</body>
</html>
