<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>资源接口管理后台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.47/vue.global.prod.min.js"></script>
</head>
<body class="bg-light">

<div id="app" class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>接口源管理 <span class="badge bg-success fs-6">已载入 db.json</span></h3>
        <div>
            <button class="btn btn-outline-secondary me-2" @click="fetchFromDb">刷新数据</button>
            <button class="btn btn-success me-2" @click="addSite">+ 新增接口</button>
            <button class="btn btn-primary" @click="saveSites">保存配置</button>
        </div>
    </div>

    <div class="card shadow-sm">
        <table class="table table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th width="10%">启用</th>
                    <th width="15%">标识(Key)</th>
                    <th width="20%">名称</th>
                    <th>API 地址 (Maccms V10)</th>
                    <th width="15%">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(site, index) in sites" :key="index">
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" v-model="site.active">
                        </div>
                    </td>
                    <td><input type="text" v-model="site.key" class="form-control form-control-sm"></td>
                    <td><input type="text" v-model="site.name" class="form-control form-control-sm"></td>
                    <td><input type="text" v-model="site.api" class="form-control form-control-sm"></td>
                    <td>
                        <button class="btn btn-danger btn-sm" @click="removeSite(index)">删除</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="mt-3 alert alert-info small">
        <strong>注意：</strong> 由于 Cloudflare Pages 是静态托管，修改后的数据<b>无法直接写回</b>服务器上的 <code>db.json</code>。
        <br>点击“保存”会将配置保存到您的浏览器。若要永久生效，请下载配置并手动更新 GitHub 仓库中的文件。
    </div>
</div>

<script>
    const { createApp } = Vue;
    createApp({
        data() {
            return {
                sites: []
            }
        },
        async mounted() {
            // 页面加载时自动获取 db.json
            await this.fetchFromDb();
        },
        methods: {
            // 核心逻辑：从服务器获取 db.json 文件
            async fetchFromDb() {
                try {
                    // 尝试读取同级目录下的 db.json
                    const res = await fetch('./db.json');
                    if (!res.ok) throw new Error('无法读取 db.json');
                    const data = await res.json();
                    
                    // 假设 db.json 的格式是数组 [{}, {}]
                    // 如果你的格式是 { "sites": [] }，请改为 data.sites
                    this.sites = Array.isArray(data) ? data : data.sites;
                    console.log('成功载入 db.json');
                } catch (err) {
                    console.error('载入失败，尝试读取本地缓存:', err);
                    const localData = localStorage.getItem('my_sites_config');
                    if (localData) this.sites = JSON.parse(localData);
                }
            },
            addSite() {
                this.sites.push({ key: 'new', name: '新资源', api: '', active: true });
            },
            removeSite(index) {
                if(confirm('确定删除吗？')) this.sites.splice(index, 1);
            },
            saveSites() {
                // 保存到浏览器本地存储
                localStorage.setItem('my_sites_config', JSON.stringify(this.sites));
                
                // 打印出 JSON，方便你手动复制到 GitHub 仓库
                console.log('--- 请复制以下内容更新 db.json ---');
                console.log(JSON.stringify(this.sites, null, 2));
                
                alert('保存成功（仅限本地）。新配置已在控制台输出，请手动更新仓库中的 db.json。');
            }
        }
    }).mount('#app');
</script>
</body>
</html>
